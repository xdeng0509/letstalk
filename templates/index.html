<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Let's Talk - å¤šå­¦ç§‘è§†è§’Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #ededed;
            color: #000;
            line-height: 1.6;
            overflow: hidden;
        }
        
        /* ä¸»å®¹å™¨ - ä¸‰æ å¸ƒå±€ */
        .main-container {
            display: flex;
            height: 100vh;
        }
        
        /* å·¦ä¾§å¯¹è¯åˆ—è¡¨ */
        .sidebar-left {
            width: 250px;
            background: #f7f7f7;
            border-right: 1px solid #d9d9d9;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #d9d9d9;
        }
        
        .sidebar-header h2 {
            font-size: 18px;
            color: #333;
        }
        
        .conversation-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .conversation-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e5e5e5;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .conversation-item:hover,
        .conversation-item.active {
            background: #e5e5e5;
        }
        
        .conversation-title {
            font-weight: 500;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .conversation-preview {
            font-size: 12px;
            color: #999;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* ä¸­é—´èŠå¤©åŒºåŸŸ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ededed;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-bar {
            background: #ededed;
            border-bottom: 1px solid #d9d9d9;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-title {
            font-size: 16px;
            font-weight: 500;
        }
        
        .status-badge {
            padding: 4px 10px;
            background: #07c160;
            color: white;
            border-radius: 10px;
            font-size: 12px;
        }
        
        .status-badge.demo {
            background: #ff9800;
        }
        
        .status-badge.llm {
            background: #07c160;
        }
        
        /* å­¦ç§‘æˆå‘˜æ  */
        .member-bar {
            background: #f7f7f7;
            padding: 10px 15px;
            border-bottom: 1px solid #d9d9d9;
            display: flex;
            gap: 10px;
            overflow-x: auto;
        }
        
        .member-avatar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 50px;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .avatar:hover {
            transform: scale(1.1);
        }
        
        .member-name {
            font-size: 11px;
            color: #666;
            white-space: nowrap;
        }
        
        /* æ¶ˆæ¯åŒºåŸŸ */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            animation: messageSlideIn 0.3s ease;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            margin-right: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        .message.user .message-avatar {
            margin-right: 0;
            margin-left: 10px;
            order: 2;
            background: #25D366;
            border-radius: 50%;
            width: 42px;
            height: 42px;
            font-size: 20px;
            box-shadow: 0 2px 8px rgba(37, 211, 102, 0.4);
        }
        
        /* ç³»ç»Ÿæ¶ˆæ¯å¤´åƒ */
        .message.system .message-avatar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(240, 147, 251, 0.4);
        }
        
        /* Agentæ¶ˆæ¯å¤´åƒ - æ ¹æ®å­¦ç§‘åŠ¨æ€è®¾ç½® */
        .message.agent .message-avatar {
            border-radius: 12px;
            width: 44px;
            height: 44px;
            font-size: 22px;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }
        
        .message-content {
            max-width: 60%;
        }
        
        .message.user .message-content {
            order: 1;
        }
        
        .message-sender {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }
        
        .message.user .message-sender {
            text-align: right;
        }
        
        .message-bubble {
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            word-wrap: break-word;
            line-height: 1.6;
        }
        
        .message.user .message-bubble {
            background: #95ec69;
        }
        
        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }
        
        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            background: #f7f7f7;
            border-top: 1px solid #d9d9d9;
            padding: 15px;
        }
        
        .input-toolbar {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .toolbar-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .toolbar-btn:hover {
            opacity: 1;
        }
        
        .input-wrapper {
            display: flex;
            gap: 10px;
        }
        
        .input-box {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #d9d9d9;
            border-radius: 5px;
            background: white;
            font-size: 14px;
            resize: none;
            min-height: 40px;
            max-height: 100px;
            font-family: inherit;
        }
        
        .input-box:focus {
            outline: none;
            border-color: #07c160;
        }
        
        .send-btn {
            padding: 10px 20px;
            background: #07c160;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .send-btn:hover {
            background: #06ad56;
        }
        
        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* å³ä¾§æ“ä½œæ  */
        .sidebar-right {
            width: 300px;
            background: #f7f7f7;
            border-left: 1px solid #d9d9d9;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 15px;
        }
        
        .example-questions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .example-btn {
            padding: 10px 12px;
            background: white;
            border: 1px solid #d9d9d9;
            border-radius: 5px;
            font-size: 13px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .example-btn:hover {
            background: #576b95;
            color: white;
            border-color: #576b95;
        }
        
        /* ä¸‹ä¸€æ­¥æ“ä½œåŒº - åœ¨èŠå¤©æ¡†å†…æ˜¾ç¤º */
        .next-actions-inline {
            display: none;
            margin: 20px auto;
            max-width: 80%;
            animation: slideIn 0.4s ease;
        }
        
        .next-actions-inline.show {
            display: block;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .action-card-inline {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #e1e8ed;
        }
        
        .action-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .action-card-header .icon {
            font-size: 24px;
        }
        
        .subject-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .subject-option-btn {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        
        .subject-option-btn:hover {
            border-color: #576b95;
            background: #f0f4ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(87, 107, 149, 0.2);
        }
        
        .subject-option-btn.selected {
            border-color: #576b95;
            background: #576b95;
            color: white;
        }
        
        .subject-option-btn .emoji {
            font-size: 20px;
        }
        
        .action-submit-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .action-submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }
        
        .action-submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .action-submit-btn.pk-style {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3);
        }
        
        .action-submit-btn.pk-style:hover:not(:disabled) {
            box-shadow: 0 6px 16px rgba(245, 87, 108, 0.4);
        }
        
        .action-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #e5e5e5;
        }
        
        .action-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .subject-selector {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .subject-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .subject-checkbox-item:hover {
            background: #e9ecef;
        }
        
        .subject-checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .subject-label {
            font-size: 13px;
        }
        
        .action-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }
        
        .action-btn.primary {
            background: #576b95;
            color: white;
        }
        
        .action-btn.primary:hover {
            background: #485a80;
        }
        
        .action-btn.pk {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .action-btn.pk:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(245, 87, 108, 0.3);
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* å»ºè®®é—®é¢˜ */
        .suggestions-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .suggestion-item {
            padding: 10px 12px;
            background: #e3f2fd;
            border-left: 3px solid #576b95;
            border-radius: 5px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .suggestion-item:hover {
            background: #bbdefb;
            transform: translateX(3px);
        }
        
        /* PKç»“æœå±•ç¤º */
        .pk-result {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .pk-subject {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .pk-subject:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .pk-subject-name {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .pk-viewpoint {
            background: #f0f7ff;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 13px;
            border-left: 3px solid #576b95;
        }
        
        .pk-arguments {
            font-size: 12px;
            color: #666;
        }
        
        .pk-argument {
            padding: 6px 0;
            padding-left: 15px;
            position: relative;
        }
        
        .pk-argument::before {
            content: 'â€¢';
            position: absolute;
            left: 5px;
        }
        
        .fun-fact {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-top: 10px;
            text-align: center;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 15px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: translateY(0);
            }
            30% {
                opacity: 1;
                transform: translateY(-10px);
            }
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 1024px) {
            .sidebar-left {
                width: 200px;
            }
            
            .sidebar-right {
                width: 250px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar-left {
                display: none;
            }
            
            .sidebar-right {
                width: 100%;
                position: fixed;
                right: -100%;
                transition: right 0.3s;
                z-index: 100;
            }
            
            .sidebar-right.show {
                right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- å·¦ä¾§å¯¹è¯åˆ—è¡¨ -->
        <div class="sidebar-left">
            <div class="sidebar-header">
                <h2>ğŸ Let's Talk</h2>
            </div>
            <div class="conversation-list">
                <div class="conversation-item active">
                    <div class="conversation-title">å¤šå­¦ç§‘è§†è§’è®¨è®º</div>
                    <div class="conversation-preview">å¼€å§‹ä½ çš„è·¨å­¦ç§‘æ¢ç´¢ä¹‹æ—…</div>
                </div>
            </div>
        </div>

        <!-- ä¸­é—´èŠå¤©åŒºåŸŸ -->
        <div class="chat-area">
            <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
            <div class="top-bar">
                <div class="chat-title">å¤šå­¦ç§‘è§†è§’è®¨è®º</div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <!-- æ¨¡å¼åˆ‡æ¢ -->
                    <div class="mode-switch" id="modeSwitch" style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 13px; color: #666;">è¿è¡Œæ¨¡å¼:</label>
                        <select id="modeSelector" onchange="switchMode()" style="padding: 5px 10px; border-radius: 5px; border: 1px solid #d9d9d9; font-size: 13px; cursor: pointer;">
                            <option value="demo">ğŸ­ æ¼”ç¤ºæ¨¡å¼</option>
                            <option value="llm">ğŸ¤– LLMæ¨¡å¼</option>
                        </select>
                    </div>
                    <div class="status-badge" id="statusBadge">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- å­¦ç§‘æˆå‘˜æ  -->
            <div class="member-bar" id="memberBar">
                <div class="member-avatar">
                    <div class="avatar">ğŸ‘¥</div>
                    <div class="member-name">ç­‰å¾…ä¸­</div>
                </div>
            </div>

            <!-- æ¶ˆæ¯åŒºåŸŸ -->
            <div class="messages-container" id="messagesContainer">
                <div class="message system">
                    <div class="message-avatar">ğŸ</div>
                    <div class="message-content">
                        <div class="message-sender">Let's Talk åŠ©æ‰‹</div>
                        <div class="message-bubble">
                            æ¬¢è¿æ¥åˆ°Let's Talkï¼è¿™é‡Œæœ‰å¤šä½å­¦ç§‘ä¸“å®¶Agentç­‰å¾…ä¸ºä½ è§£ç­”é—®é¢˜ã€‚<br><br>
                            ğŸ’¡ æå‡ºä¸€ä¸ªé—®é¢˜ï¼Œç³»ç»Ÿä¼šéšæœºè§£é”3ä¸ªç›¸å…³å­¦ç§‘çš„ä¸“å®¶ï¼Œä»–ä»¬ä¼šä»ä¸åŒè§’åº¦ä¸ºä½ è§£ç­”ã€‚<br><br>
                            ä½ ä¹Ÿå¯ä»¥åœ¨å³ä¾§é€‰æ‹©ç¤ºä¾‹é—®é¢˜å¿«é€Ÿå¼€å§‹ï¼
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-area">
                <div class="input-toolbar">
                    <button class="toolbar-btn" title="è¡¨æƒ…">ğŸ˜Š</button>
                    <button class="toolbar-btn" title="æ–‡ä»¶">ğŸ“</button>
                    <button class="toolbar-btn" title="å›¾ç‰‡">ğŸ–¼ï¸</button>
                </div>
                <div class="input-wrapper">
                    <textarea class="input-box" id="messageInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." rows="1"></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">å‘é€</button>
                </div>
            </div>
        </div>

        <!-- å³ä¾§æ“ä½œæ  -->
        <div class="sidebar-right">
            <!-- ç¤ºä¾‹é—®é¢˜ -->
            <div class="sidebar-section" id="exampleQuestionsSection">
                <div class="section-title">ğŸ’¡ ç¤ºä¾‹é—®é¢˜</div>
                <div class="example-questions" id="exampleQuestions">
                    <button class="example-btn" data-question="ä¸ºä»€ä¹ˆäººä¼šæ‹–å»¶ï¼Ÿ">ä¸ºä»€ä¹ˆäººä¼šæ‹–å»¶ï¼Ÿ</button>
                    <button class="example-btn" data-question="å¦‚ä½•æé«˜å­¦ä¹ æ•ˆç‡ï¼Ÿ">å¦‚ä½•æé«˜å­¦ä¹ æ•ˆç‡ï¼Ÿ</button>
                    <button class="example-btn" data-question="çˆ±æƒ…çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ">çˆ±æƒ…çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ</button>
                    <button class="example-btn" data-question="å¦‚ä½•åšå‡ºé‡è¦å†³ç­–ï¼Ÿ">å¦‚ä½•åšå‡ºé‡è¦å†³ç­–ï¼Ÿ</button>
                    <button class="example-btn" data-question="ç¤¾äº¤ç„¦è™‘å¦‚ä½•å…‹æœï¼Ÿ">ç¤¾äº¤ç„¦è™‘å¦‚ä½•å…‹æœï¼Ÿ</button>
                </div>
            </div>

            <!-- ä¸‹ä¸€æ­¥æ“ä½œ -->
            <div class="sidebar-section next-actions" id="nextActions">
                <div class="section-title">ğŸ“Œ ä¸‹ä¸€æ­¥æ“ä½œ</div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="action-buttons" style="display: flex; flex-direction: column; gap: 10px;"></div>
                
                <!-- æ·±å…¥å•èŠï¼ˆå·²éšè—ï¼‰ -->
                <div class="action-card" style="display: none;">
                    <div class="action-title">ğŸ’¬ æ·±å…¥å•èŠ</div>
                    <div class="subject-selector" id="singleChatSelector"></div>
                    <button class="action-btn primary" onclick="startDeepChat()" id="deepChatBtn" disabled>å¼€å§‹æ·±å…¥å¯¹è¯</button>
                </div>
            </div>

            <!-- ä¸‹ä¸€æ­¥æé—®å»ºè®®ï¼ˆåŸºäºå½“å‰å¯¹è¯ä¸Šä¸‹æ–‡ï¼‰ -->
            <div class="sidebar-section" id="suggestionsSection" style="display: none;">
                <div class="section-title">ğŸ’¡ ä¸‹ä¸€æ­¥æé—®å»ºè®®</div>
                <div class="suggestions-list" id="suggestionsList"></div>
            </div>

            <!-- å­¦ç§‘æ´¾åˆ«PKï¼ˆæ·±å…¥å¯¹è¯åæ˜¾ç¤ºï¼‰ -->
            <div class="sidebar-section" id="schoolPKSection" style="display: none;">
                <div class="section-title">âš”ï¸ å­¦ç§‘æ´¾åˆ«PK</div>
                <p style="font-size: 12px; color: #666; margin-bottom: 12px;">é€‰æ‹©è¯¥å­¦ç§‘å†…çš„ä¸¤ä¸ªæ´¾åˆ«è¿›è¡Œè§‚ç‚¹å¯¹å†³</p>
                <div class="action-card">
                    <div class="subject-selector" id="schoolSelector"></div>
                    <button class="action-btn pk" onclick="startSchoolPK()" id="schoolPKBtn" disabled>å¼€å§‹æ´¾åˆ«PK</button>
                </div>
            </div>

            <!-- PKç»“æœï¼ˆPKåæ˜¾ç¤ºï¼‰ -->
            <div class="sidebar-section" id="pkResultSection" style="display: none;">
                <div class="section-title">ğŸ“Š PKç»“æœ</div>
                <div id="pkResultContent"></div>
            </div>
        </div>
    </div>

    <script>
        let demoMode = false;
        let llmAvailable = false;
        let currentMode = 'demo';
        let messageDelay = 1500; // æ¶ˆæ¯é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰- æ¨¡æ‹ŸçœŸå®èŠå¤©
        let pkStatementDelay = 1200; // PKå‘è¨€é—´éš”ï¼ˆæ¯«ç§’ï¼‰- PKæ—¶ç¨å¿«ä¸€äº›
        
        // å¯¹è¯ç®¡ç†
        let conversations = [];  // æ‰€æœ‰å¯¹è¯åˆ—è¡¨
        let currentConversationId = null;  // å½“å‰æ¿€æ´»çš„å¯¹è¯ID
        let conversationIdCounter = 1;  // å¯¹è¯IDè®¡æ•°å™¨
        
        // å¯¹è¯ç±»å‹
        const CONVERSATION_TYPES = {
            GROUP: 'group',      // ç¾¤èŠï¼ˆå¤šå­¦ç§‘è®¨è®ºï¼‰
            DEEP: 'deep',        // æ·±å…¥å•èŠ
            PK: 'pk'             // PKå¯¹è¯
        };

        // å¯¹è¯æ•°æ®ç»“æ„
        class Conversation {
            constructor(type, title, icon = 'ğŸ’¬') {
                this.id = conversationIdCounter++;
                this.type = type;  // group, deep, pk
                this.title = title;
                this.icon = icon;
                this.messages = [];
                this.members = [];  // æˆå‘˜åˆ—è¡¨ï¼ˆå­¦ç§‘ï¼‰
                this.context = {
                    question: '',
                    subjects: [],
                    deepSubject: null,
                    pkState: null
                };
                this.createdAt = new Date();
                this.lastMessageAt = new Date();
                this.preview = 'å¼€å§‹å¯¹è¯...';
            }
            
            addMessage(message) {
                this.messages.push(message);
                this.lastMessageAt = new Date();
                this.preview = message.content.substring(0, 30);
            }
            
            updateTitle(newTitle) {
                this.title = newTitle;
            }
        }
        
        // é¡µé¢åŠ è½½
        window.onload = async function() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                demoMode = data.demo_mode;
                llmAvailable = data.llm_available;
                currentMode = data.current_mode;
                
                // æ›´æ–°çŠ¶æ€å¾½ç« 
                updateStatusBadge();
                
                // æ›´æ–°æ¨¡å¼é€‰æ‹©å™¨
                const modeSelector = document.getElementById('modeSelector');
                modeSelector.value = currentMode;
                
                // å¦‚æœLLMä¸å¯ç”¨ï¼Œç¦ç”¨LLMé€‰é¡¹
                if (!llmAvailable) {
                    const llmOption = modeSelector.querySelector('option[value="llm"]');
                    llmOption.disabled = true;
                    llmOption.textContent = 'ğŸ¤– LLMæ¨¡å¼ (ä¸å¯ç”¨)';
                }
                
                // åˆ›å»ºé»˜è®¤ç¾¤èŠå¯¹è¯
                createDefaultConversation();
            } catch (error) {
                console.error('è·å–çŠ¶æ€å¤±è´¥:', error);
            }
        };
        
        // åˆ›å»ºé»˜è®¤ç¾¤èŠå¯¹è¯
        function createDefaultConversation() {
            const conv = new Conversation(CONVERSATION_TYPES.GROUP, 'å¤šå­¦ç§‘è§†è§’è®¨è®º', 'ğŸ‘¥');
            conversations.push(conv);
            currentConversationId = conv.id;
            
            // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
            conv.addMessage({
                type: 'system',
                sender: 'Let\'s Talk åŠ©æ‰‹',
                content: 'æ¬¢è¿æ¥åˆ°Let\'s Talkï¼è¿™é‡Œæœ‰å¤šä½å­¦ç§‘ä¸“å®¶Agentç­‰å¾…ä¸ºä½ è§£ç­”é—®é¢˜ã€‚\n\nğŸ’¡ æå‡ºä¸€ä¸ªé—®é¢˜ï¼Œç³»ç»Ÿä¼šéšæœºè§£é”3ä¸ªç›¸å…³å­¦ç§‘çš„ä¸“å®¶ï¼Œä»–ä»¬ä¼šä»ä¸åŒè§’åº¦ä¸ºä½ è§£ç­”ã€‚\n\nä½ ä¹Ÿå¯ä»¥åœ¨å³ä¾§é€‰æ‹©ç¤ºä¾‹é—®é¢˜å¿«é€Ÿå¼€å§‹ï¼',
                avatar: 'ğŸ',
                timestamp: new Date()
            });
            
            // æ¸²æŸ“å¯¹è¯åˆ—è¡¨å’Œæ¶ˆæ¯
            renderConversationList();
            switchConversation(conv.id);
        }

        
        // æ¸²æŸ“å¯¹è¯åˆ—è¡¨
        function renderConversationList() {
            const listContainer = document.querySelector('.conversation-list');
            listContainer.innerHTML = '';
            
            // æŒ‰æœ€åæ¶ˆæ¯æ—¶é—´å€’åºæ’åˆ—
            const sortedConvs = [...conversations].sort((a, b) => b.lastMessageAt - a.lastMessageAt);
            
            sortedConvs.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                if (conv.id === currentConversationId) {
                    item.classList.add('active');
                }
                
                item.innerHTML = `
                    <div class="conversation-title">${conv.icon} ${conv.title}</div>
                    <div class="conversation-preview">${conv.preview}</div>
                `;
                
                item.onclick = () => switchConversation(conv.id);
                listContainer.appendChild(item);
            });
        }
        
        // åˆ‡æ¢å¯¹è¯ï¼ˆè‹¥è¾“å‡ºé”å¼€å¯åˆ™ç¦æ­¢åˆ‡æ¢ï¼‰
        function switchConversation(convId) {
            if (window.uiState && window.uiState.outputLocked) {
                // å¯é€‰æç¤ºï¼š
                const toast = document.getElementById('globalToast');
                if (toast) {
                    toast.textContent = 'å½“å‰å¯¹è¯æ­£åœ¨è¾“å‡ºï¼Œè¯·ç¨å€™...';
                    toast.style.display = 'block';
                    setTimeout(() => { toast.style.display = 'none'; }, 1500);
                }
                return;
            }
            const conv = conversations.find(c => c.id === convId);
            if (!conv) return;
            
            currentConversationId = convId;
            
            // æ›´æ–°å¯¹è¯åˆ—è¡¨é«˜äº®
            renderConversationList();
            
            // æ›´æ–°é¡¶éƒ¨æ ‡é¢˜
            document.querySelector('.chat-title').textContent = conv.title;
            
            // æ¸²æŸ“æ¶ˆæ¯
            renderMessages(conv);
            
            // éšè—æˆå‘˜æ ï¼ˆæ”¹ä¸ºåªåœ¨éœ€è¦æ—¶æ˜¾ç¤ºï¼‰
            const memberBar = document.getElementById('memberBar');
            memberBar.style.display = 'none';
            
            // æ›´æ–°å³ä¾§æ“ä½œåŒº
            updateSidebar(conv);
        }
        
        // æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
        function renderMessages(conv) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            conv.messages.forEach(msg => {
                const messageEl = createMessageElement(msg);
                container.appendChild(messageEl);
            });
            
            container.scrollTop = container.scrollHeight;
        }
        
        // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
        function createMessageElement(msg) {
            const message = document.createElement('div');
            message.className = `message ${msg.type}`;
            
            // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®ä¸åŒçš„å¤´åƒæ ·å¼
            let avatarStyle = '';
            let avatarIcon = msg.avatar || 'ğŸ¤–';
            
            if (msg.type === 'user') {
                avatarIcon = 'ğŸ‘¤';
            } else if (msg.type === 'system') {
                avatarIcon = 'ğŸ¤–';
            } else if (msg.type === 'agent') {
                // Agentå¤´åƒä½¿ç”¨ä¼ å…¥çš„iconï¼Œå¹¶è®¾ç½®ç‹¬ç‰¹çš„èƒŒæ™¯è‰²
                avatarIcon = msg.avatar;
                const colorMap = {
                    'ğŸ§ ': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'ğŸ’°': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'ğŸ›ï¸': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'âš–ï¸': 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                    'âš—ï¸': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    'ğŸ¨': 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                    'ğŸ“š': 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                    'ğŸŒ': 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                    'ğŸ”¢': 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                    'ğŸ’»': 'linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%)',
                    'ğŸ¥': 'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)',
                    'ğŸ­': 'linear-gradient(135deg, #f8b500 0%, #fceabb 100%)',
                    'ğŸ”¬': 'linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)',
                    'ğŸ“–': 'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)',
                    'ğŸŒŸ': 'linear-gradient(135deg, #fddb92 0%, #d1fdff 100%)'
                };
                const bgColor = colorMap[avatarIcon] || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                avatarStyle = `style="background: ${bgColor}"`;
            }
            
            message.innerHTML = `
                <div class="message-avatar" ${avatarStyle}>${avatarIcon}</div>
                <div class="message-content">
                    <div class="message-sender">${msg.sender}</div>
                    <div class="message-bubble">${msg.content}</div>
                </div>
            `;
            
            return message;
        }
        
        // æ›´æ–°å³ä¾§æ 
        function updateSidebar(conv) {
            // æ ¹æ®å¯¹è¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ“ä½œåŒº
            const nextActions = document.getElementById('nextActions');
            const suggestionsSection = document.getElementById('suggestionsSection');
            const schoolPKSection = document.getElementById('schoolPKSection');
            const exampleQuestionsSection = document.getElementById('exampleQuestionsSection');
            
            if (conv.type === CONVERSATION_TYPES.GROUP) {
                // ç¾¤èŠï¼šæ˜¾ç¤ºç¤ºä¾‹é—®é¢˜ï¼Œå¦‚æœæœ‰subjectsåˆ™æ˜¾ç¤º"æ¢ä¸€æ‰¹"å’Œ"æ·±å…¥å¯¹è¯"
                if (exampleQuestionsSection) exampleQuestionsSection.style.display = 'block';
                
                if (conv.context.subjects && conv.context.subjects.length > 0) {
                    showNextActions(conv.context.subjects);
                } else {
                    nextActions.style.display = 'none';
                }
                if (suggestionsSection) suggestionsSection.style.display = 'none';
            } else if (conv.type === CONVERSATION_TYPES.DEEP && conv.context.deepSubject) {
                // æ·±å…¥å•èŠï¼šæ ¹æ®æ˜¯å¦æ­£åœ¨PKå†³å®šæ˜¾ç¤ºå“ªäº›åŒºåŸŸ
                const inPK = !!(conv.context.pkState && conv.context.pkState.active);
                nextActions.style.display = 'none';
                if (exampleQuestionsSection) exampleQuestionsSection.style.display = 'none';
                
                if (inPK) {
                    // PKè¿›è¡Œä¸­ï¼šéšè—å»ºè®®é—®é¢˜ä¸æ´¾ç³»é€‰æ‹©
                    if (suggestionsSection) suggestionsSection.style.display = 'none';
                    if (schoolPKSection) schoolPKSection.style.display = 'none';
                } else {
                    // éPKï¼šæ˜¾ç¤ºå»ºè®®é—®é¢˜ä¸æ´¾ç³»é€‰æ‹©
                    if (suggestionsSection) suggestionsSection.style.display = 'block';
                    if (schoolPKSection && conv.context.schools && conv.context.schools.length > 0) {
                        showSchoolPKOptions(conv.context.schools, conv.context.deepSubject.name);
                    } else {
                        if (schoolPKSection) schoolPKSection.style.display = 'none';
                    }
                }
            } else {
                // å…¶ä»–æƒ…å†µï¼šæ˜¾ç¤ºç¤ºä¾‹é—®é¢˜
                nextActions.style.display = 'none';
                if (suggestionsSection) suggestionsSection.style.display = 'none';
                if (schoolPKSection) schoolPKSection.style.display = 'none';
                if (exampleQuestionsSection) exampleQuestionsSection.style.display = 'block';
            }
        }

        // æ›´æ–°çŠ¶æ€å¾½ç« 
        function updateStatusBadge() {
            const badge = document.getElementById('statusBadge');
            if (currentMode === 'demo') {
                badge.textContent = 'ğŸ­ æ¼”ç¤ºæ¨¡å¼';
                badge.classList.add('demo');
                badge.classList.remove('llm');
            } else {
                badge.textContent = 'âœ… LLMæ¨¡å¼';
                badge.classList.remove('demo');
                badge.classList.add('llm');
            }
        }

        // åˆ‡æ¢æ¨¡å¼
        async function switchMode() {
            const modeSelector = document.getElementById('modeSelector');
            const newMode = modeSelector.value;
            
            if (newMode === currentMode) {
                return;
            }
            
            try {
                const response = await fetch('/api/set-mode', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ mode: newMode })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentMode = newMode;
                    updateStatusBadge();
                    
                    // æ˜¾ç¤ºåˆ‡æ¢æˆåŠŸæç¤º
                    addMessage('system', 'Let\'s Talk åŠ©æ‰‹', `âœ… ${data.message}`);
                } else {
                    // åˆ‡æ¢å¤±è´¥ï¼Œæ¢å¤é€‰æ‹©
                    modeSelector.value = currentMode;
                    addMessage('system', 'Let\'s Talk åŠ©æ‰‹', `âŒ ${data.error}`);
                }
            } catch (error) {
                console.error('åˆ‡æ¢æ¨¡å¼å¤±è´¥:', error);
                modeSelector.value = currentMode;
                addMessage('system', 'Let\'s Talk åŠ©æ‰‹', `âŒ åˆ‡æ¢æ¨¡å¼å¤±è´¥ï¼š${error.message}`);
            }
        }

        // é€‰æ‹©ç¤ºä¾‹é—®é¢˜
        function selectQuestion(question) {
            // ç¡®ä¿æœ‰å½“å‰å¯¹è¯
            if (!currentConversationId || currentConversationId < 0) {
                console.log('å¯¹è¯æœªåˆå§‹åŒ–ï¼Œæ­£åœ¨åˆ›å»ºé»˜è®¤å¯¹è¯');
                createDefaultConversation();
            }
            
            const input = document.getElementById('messageInput');
            if (input) {
                input.value = question;
                input.focus();
                // ä½¿ç”¨setTimeoutç¡®ä¿DOMæ›´æ–°åå†å‘é€
                setTimeout(() => sendMessage(), 100);
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const question = input.value.trim();
            
            if (!question) return;

            const conv = conversations.find(c => c.id === currentConversationId);
            if (!conv) return;
            
            // å¦‚æœåœ¨PKå¯¹è¯ä¸­ï¼Œä½¿ç”¨ç‰¹æ®Šå¤„ç†
            if (conv.type === CONVERSATION_TYPES.PK && conv.context.pkState && conv.context.pkState.active) {
                input.value = '';
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                addMessageToConversation('user', 'æˆ‘', question);
                
                // ç­‰å¾…åæ‰§è¡Œä¸‹ä¸€è½®PKï¼Œä¼ é€’ç”¨æˆ·è¾“å…¥
                await sleep(600);
                conv.context.pkState.userInput = question;
                await executePKRound();
                return;
            }
            
            // DEEP å¯¹è¯ï¼ˆåŒ…å«æ´¾ç³»å•èŠï¼‰ä¼˜å…ˆèµ° deep-chatï¼Œä¿è¯ä»£è¡¨äººèº«ä»½ä¸€è‡´
            if (conv.type === CONVERSATION_TYPES.DEEP && conv.context.deepSubject) {
                input.value = '';
                addMessageToConversation('user', 'æˆ‘', question);
                await sleep(600);
                showTypingIndicator();
                try {
                    const representative = conv.context.schoolChat ? conv.context.schoolChat.representativeName : undefined;
                    const response = await fetch('/api/deep-chat', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            question: question,
                            subject_name: conv.context.deepSubject.name,
                            context: conv.context.question || conv.context.originalQuestion || '',
                            representative
                        })
                    });
                    const data = await response.json();
                    await sleep(600);
                    removeTypingIndicator();
                    if (data.success) {
                        let displayName = conv.context.deepSubject.name;
                        let displayAvatar = conv.context.deepSubject.icon;
                        if (conv.context.schoolChat) {
                            displayName = conv.context.schoolChat.representativeName || displayName;
                            displayAvatar = conv.context.schoolChat.representativeAvatar || displayAvatar;
                        }
                        addMessageToConversation('agent', displayName, data.answer, displayAvatar);
                        updateRuntimeBadge(data.llm_provider, data.used_demo);
                        if (data.suggestions) {
                            showSuggestions(data.suggestions, conv.context.deepSubject.name, conv.context.deepSubject.icon);
                        }
                    } else {
                        addMessageToConversation('system', "Let's Talk åŠ©æ‰‹", `é”™è¯¯ï¼š${data.error}`);
                    }
                } catch (error) {
                    removeTypingIndicator();
                    addMessageToConversation('system', "Let's Talk åŠ©æ‰‹", `è¯·æ±‚å¤±è´¥ï¼š${error.message}`);
                }
                return;
            }
            
            input.value = '';
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å½“å‰å¯¹è¯
            const userMsg = {
                type: 'user',
                sender: 'æˆ‘',
                content: question,
                avatar: 'ğŸ‘¤',
                timestamp: new Date()
            };
            conv.addMessage(userMsg);
            renderMessages(conv);
            renderConversationList();

            // ç¦ç”¨å‘é€æŒ‰é’®
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'æ€è€ƒä¸­...';
            // åŒæ­¥åŠ é”ï¼Œé˜²æ­¢åˆ‡æ¢
            window.uiState.outputLocked = true;
            window.uiState.typingCounter = (window.uiState.typingCounter || 0) + 1;

            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥
            showTypingIndicator();

            try {
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        question, 
                        subject_count: 3,
                        subject_personas: (conv.context && conv.context.subjectPersonas) ? conv.context.subjectPersonas : undefined,
                        conversation_id: conv.id
                    })
                });

                const data = await response.json();

                // ç§»é™¤æ­£åœ¨è¾“å…¥
                removeTypingIndicator();

                if (data.success) {
                    // ä¿å­˜é—®é¢˜å’Œå­¦ç§‘åˆ°å¯¹è¯ä¸Šä¸‹æ–‡
                    conv.context.question = question;
                    conv.context.subjects = data.subjects;
                    
                    // æ„å»ºå¹¶æŒä¹…åŒ–æ¯ä¸ªå­¦ç§‘çš„personaï¼ˆé»˜è®¤é€‰ç”¨ç¬¬ä¸€ä¸ªæ´¾ç³»çš„é¦–ä½ä»£è¡¨ï¼‰
                    const personas = conv.context.subjectPersonas || {};
                    data.subjects.forEach(s => {
                        // è‹¥å·²æœ‰ persona åˆ™ä¿ç•™ï¼ˆèº«ä»½ç¨³å®šï¼‰
                        if (personas[s.name]) return;
                        let representativeName = s.name;
                        let representativeAvatar = s.icon;
                        if (s.schools && s.schools.length > 0) {
                            const firstSchool = s.schools[0];
                            const reps = (firstSchool.representative || '').split('ã€');
                            const rep = reps[0] ? reps[0].trim() : s.name;
                            representativeName = rep;
                            // å¤ç”¨ä»£è¡¨å¤´åƒæ˜ å°„
                            const url = representativeAvatarMap && representativeAvatarMap[rep] ? representativeAvatarMap[rep] : '';
                            representativeAvatar = url || s.icon;
                            personas[s.name] = {
                                subjectName: s.name,
                                schoolName: firstSchool.name,
                                representativeName: representativeName,
                                representativeAvatar: representativeAvatar
                            };
                        } else {
                            personas[s.name] = {
                                subjectName: s.name,
                                schoolName: undefined,
                                representativeName: representativeName,
                                representativeAvatar: representativeAvatar
                            };
                        }
                    });
                    conv.context.subjectPersonas = personas;
                    
                    // æˆå‘˜æ ä»ç”¨å­¦ç§‘ä¿¡æ¯ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½
                    conv.members = data.subjects;
                    
                    // æ›´æ–°ç¾¤èŠåç§°ä¸ºé—®é¢˜ï¼ˆæˆªå–å‰20å­—ï¼‰
                    const shortQuestion = question.length > 20 ? question.substring(0, 20) + '...' : question;
                    conv.updateTitle(shortQuestion);
                    
                    // é€æ¡æ˜¾ç¤ºAgentå›ç­”
                    await displaySubjectAnswers(data.subjects);
                    
                    // æ˜¾ç¤ºä¸‹ä¸€æ­¥æ“ä½œ
                    showNextActions(data.subjects);
                    
                    // åˆ·æ–°å¯¹è¯åˆ—è¡¨
                    renderConversationList();
                } else {
                    const errorMsg = {
                        type: 'system',
                        sender: 'Let\'s Talk åŠ©æ‰‹',
                        content: `æŠ±æ­‰ï¼Œå‡ºç°é”™è¯¯ï¼š${data.error}`,
                        avatar: 'ğŸ¤–',
                        timestamp: new Date()
                    };
                    conv.addMessage(errorMsg);
                    renderMessages(conv);
                }
            } catch (error) {
                removeTypingIndicator();
                const errorMsg = {
                    type: 'system',
                    sender: 'Let\'s Talk åŠ©æ‰‹',
                    content: `è¯·æ±‚å¤±è´¥ï¼š${error.message}`,
                    avatar: 'ğŸ¤–',
                    timestamp: new Date()
                };
                conv.addMessage(errorMsg);
                renderMessages(conv);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'å‘é€';
                // è§£é™¤é”ï¼ˆä¸showTypingIndicatorçš„å¼•ç”¨è®¡æ•°ä¿æŒä¸€è‡´ï¼‰
                window.uiState.typingCounter = Math.max(0, (window.uiState.typingCounter || 1) - 1);
                if (window.uiState.typingCounter === 0) {
                    window.uiState.outputLocked = false;
                }
            }
        }

        // æ·»åŠ æ¶ˆæ¯
        function addMessage(type, sender, content, avatar = '') {
            const container = document.getElementById('messagesContainer');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            
            // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®ä¸åŒçš„å¤´åƒæ ·å¼
            let avatarStyle = '';
            let avatarIcon = avatar || 'ğŸ¤–';
            let avatarHtml = '';
            
            const isUrl = typeof avatarIcon === 'string' && /^https?:\/\//.test(avatarIcon);
            
            if (type === 'user') {
                avatarIcon = 'ğŸ‘¤';
            } else if (type === 'system') {
                avatarIcon = 'ğŸ¤–';
            } else if (type === 'agent') {
                // Agentå¤´åƒä½¿ç”¨ä¼ å…¥çš„iconæˆ–URLï¼Œå¹¶è®¾ç½®ç‹¬ç‰¹çš„èƒŒæ™¯è‰²ï¼ˆä»…å½“ä¸ºemojiæ—¶ï¼‰
                avatarIcon = avatar;
                const colorMap = {
                    'ğŸ§ ': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'ğŸ’°': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'ğŸ›ï¸': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'âš–ï¸': 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                    'âš—ï¸': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    'ğŸ¨': 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                    'ğŸ“š': 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                    'ğŸŒ': 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                    'ğŸ”¢': 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                    'ğŸ’»': 'linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%)',
                    'ğŸ¥': 'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)',
                    'ğŸ­': 'linear-gradient(135deg, #f8b500 0%, #fceabb 100%)',
                    'ğŸ”¬': 'linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)',
                    'ğŸ“–': 'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)',
                    'ğŸŒŸ': 'linear-gradient(135deg, #fddb92 0%, #d1fdff 100%)'
                };
                if (!isUrl) {
                    const bgColor = colorMap[avatarIcon] || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    avatarStyle = `style="background: ${bgColor}"`;
                } else {
                    avatarStyle = '';
                }
            }
            
            // æ„å»ºå¤´åƒå†…å®¹ï¼šURLç”¨<img>ï¼Œå¦åˆ™ç›´æ¥æ–‡æœ¬ï¼ˆemojiï¼‰
            if (isUrl) {
                avatarHtml = `<img src="${avatarIcon}" alt="${sender}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" />`;
            } else {
                avatarHtml = avatarIcon;
            }
            
            message.innerHTML = `
                <div class="message-avatar" ${avatarStyle}>${avatarHtml}</div>
                <div class="message-content">
                    <div class="message-sender">${sender}</div>
                    <div class="message-bubble">${content}</div>
                </div>
            `;
            
            container.appendChild(message);
            container.scrollTop = container.scrollHeight;
            
            return message;
        }

        // å…¼å®¹å°è£…ï¼šå°†æ¶ˆæ¯åŒæ—¶å†™å…¥å½“å‰å¯¹è¯çš„æ•°æ®ç»“æ„ä¸UI
        function addMessageToConversation(type, sender, content, avatar = '') {
            // å…ˆå†™å…¥UI
            const uiMsg = addMessage(type, sender, content, avatar);
            // å†å†™å…¥å½“å‰å¯¹è¯å¯¹è±¡ï¼ˆç”¨äºå†å²ä¸åç»­é€»è¾‘ï¼‰
            try {
                const conv = conversations.find(c => c.id === currentConversationId);
                if (conv && typeof conv.addMessage === 'function') {
                    conv.addMessage({
                        type,
                        sender,
                        content,
                        avatar,
                        timestamp: new Date()
                    });
                }
            } catch (e) {
                console.error('addMessageToConversation å†™å…¥å¯¹è¯å¤±è´¥:', e);
            }
            return uiMsg;
        }

        // å…¨å±€è¾“å‡ºé”ï¼ˆç¦æ­¢åˆ‡æ¢å¯¹è¯æœŸé—´ï¼‰
        window.uiState = window.uiState || { outputLocked: false, typingCounter: 0 };
        
        // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨ï¼ˆåŠ é”ï¼‰
        function showTypingIndicator() {
            const container = document.getElementById('messagesContainer');
            const indicator = document.createElement('div');
            indicator.className = 'message typing-message';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = `
                <div class="message-avatar" style="background: linear-gradient(135deg, #95ec69 0%, #7ed957 100%); opacity: 0.7;">ğŸ’¬</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(indicator);
            container.scrollTop = container.scrollHeight;
            
            // åŠ é”å¹¶è®¡æ•°
            try {
                window.uiState.typingCounter = (window.uiState.typingCounter || 0) + 1;
                window.uiState.outputLocked = true;
                // æ˜¾ç¤ºé”æç¤ºï¼ˆå¯é€‰ï¼‰
                const chatTitle = document.querySelector('.chat-title');
                if (chatTitle) chatTitle.dataset.locked = 'true';
            } catch (e) {}
        }

        // ç§»é™¤æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨ï¼ˆè§£é”ï¼šå¼•ç”¨è®¡æ•°ï¼‰
        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
            try {
                window.uiState.typingCounter = Math.max(0, (window.uiState.typingCounter || 0) - 1);
                if (window.uiState.typingCounter === 0) {
                    window.uiState.outputLocked = false;
                    const chatTitle = document.querySelector('.chat-title');
                    if (chatTitle) delete chatTitle.dataset.locked;
                }
            } catch (e) {}
        }

        // æ›´æ–°å­¦ç§‘æˆå‘˜æ 
        function updateMemberBar(subjects) {
            const memberBar = document.getElementById('memberBar');
            memberBar.innerHTML = '';
            
            // ä¸ºæ¯ä¸ªå­¦ç§‘è®¾ç½®ç‹¬ç‰¹çš„é¢œè‰²
            const colorMap = {
                'ğŸ§ ': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'ğŸ’°': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'ğŸ›ï¸': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'âš–ï¸': 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                'âš—ï¸': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'ğŸ¨': 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                'ğŸ“š': 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                'ğŸŒ': 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                'ğŸ”¢': 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                'ğŸ’»': 'linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%)',
                'ğŸ¥': 'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)',
                'ğŸ­': 'linear-gradient(135deg, #f8b500 0%, #fceabb 100%)',
                'ğŸ”¬': 'linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)',
                'ğŸ“–': 'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)',
                'ğŸŒŸ': 'linear-gradient(135deg, #fddb92 0%, #d1fdff 100%)',
                'ğŸ—£ï¸': 'linear-gradient(135deg, #c471f5 0%, #fa71cd 100%)',
                'ğŸŒ±': 'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)',
                'ğŸ’­': 'linear-gradient(135deg, #a6c0fe 0%, #f68084 100%)',
                'ğŸ¯': 'linear-gradient(135deg, #fccb90 0%, #d57eeb 100%)',
                'ğŸ”®': 'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)'
            };
            
            subjects.forEach(subject => {
                const bgColor = colorMap[subject.icon] || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                const member = document.createElement('div');
                member.className = 'member-avatar';
                member.innerHTML = `
                    <div class="avatar" style="background: ${bgColor}">${subject.icon}</div>
                    <div class="member-name">${subject.name}</div>
                `;
                memberBar.appendChild(member);
            });
        }

        // é€æ¡æ˜¾ç¤ºå­¦ç§‘å›ç­”

        // æ¢ä¸€æ‰¹é—®é¢˜
        async function resetAndAskNewQuestion() {
            const currentConv = conversations.find(c => c.id === currentConversationId);
            if (!currentConv) return;
            
            const question = currentConv.context.question;
            
            addMessage('system', 'Let\'s Talk åŠ©æ‰‹', 'æ­£åœ¨ä¸ºæ‚¨é‡æ–°åŒ¹é…å­¦ç§‘ä¸“å®¶...');
            
            showTypingIndicator();
            
            try {
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        question, 
                        subject_count: 3,
                        subject_personas: (conv.context && conv.context.subjectPersonas) ? conv.context.subjectPersonas : undefined,
                        conversation_id: conv.id
                    })
                });

                const data = await response.json();

                removeTypingIndicator();

                if (data.success) {
                    // æ›´æ–°å­¦ç§‘
                    currentConv.context.subjects = data.subjects;
                    currentConv.members = data.subjects;
                    
                    // é€æ¡æ˜¾ç¤ºAgentå›ç­”
                    await displaySubjectAnswers(data.subjects);
                    
                    // å†æ¬¡æ˜¾ç¤ºé€‰æ‹©
                    showNextActions(data.subjects);
                } else {
                    addMessage('system', 'Let\'s Talk åŠ©æ‰‹', `å‡ºç°é”™è¯¯ï¼š${data.error}`);
                }
            } catch (error) {
                removeTypingIndicator();
                addMessage('system', 'Let\'s Talk åŠ©æ‰‹', `è¯·æ±‚å¤±è´¥ï¼š${error.message}`);
            }
        }
        
        // æ˜¾ç¤ºæ·±å…¥å¯¹è¯é€‰é¡¹ï¼ˆåœ¨æ¶ˆæ¯æ¡†ä¸­æ˜¾ç¤ºé€‰é¡¹ï¼‰
        function showDeepChatOptions() {
            const currentConv = conversations.find(c => c.id === currentConversationId);
            if (!currentConv || !currentConv.context.subjects) return;
            
            const subjects = currentConv.context.subjects;
            const container = document.getElementById('messagesContainer');
            
            // åˆ›å»ºé€‰æ‹©å¡ç‰‡
            const card = document.createElement('div');
            card.className = 'message system';
            card.innerHTML = `
                <div class="message-avatar">ğŸ“</div>
                <div class="message-content">
                    <div class="message-sender">Let's Talk åŠ©æ‰‹</div>
                    <div style="padding: 12px 0;">è¯·é€‰æ‹©è¦æ·±å…¥äº†è§£çš„å­¦ç§‘ï¼š</div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${subjects.map(subject => `
                            <button onclick="selectSubjectAndStartDeepChat('${subject.name}', '${subject.icon}')" 
                                    style="padding: 10px 12px; background: #f0f7ff; border: 1px solid #667eea; border-radius: 5px; cursor: pointer; text-align: left; transition: all 0.2s; font-size: 14px;">
                                ${subject.icon} <strong>${subject.name}</strong>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            
            container.appendChild(card);
            container.scrollTop = container.scrollHeight;
        }
        
        // é€‰æ‹©å­¦ç§‘å¹¶å¼€å§‹æ·±å…¥å¯¹è¯
        async function selectSubjectAndStartDeepChat(subjectName, subjectIcon) {
            const groupConv = conversations.find(c => c.id === currentConversationId);
            if (!groupConv || !groupConv.context.subjects) return;
            
            const subj = groupConv.context.subjects.find(s => s.name === subjectName);
            if (!subj) return;
            
            // åˆ›å»ºæ–°çš„æ·±å…¥å¯¹è¯çª—å£
            const deepConv = new Conversation(
                CONVERSATION_TYPES.DEEP,
                subjectName,  // åªæ˜¾ç¤ºå­¦ç§‘åç§°
                subjectIcon
            );
            deepConv.context.deepSubject = { name: subjectName, icon: subjectIcon };
            deepConv.context.parentConvId = groupConv.id;
            deepConv.context.subjects = groupConv.context.subjects;
            deepConv.context.question = groupConv.context.question; // ä¿å­˜åŸå§‹é—®é¢˜ï¼ˆç”¨äºPKæ—¶æºå¸¦ä¸Šä¸‹æ–‡ï¼‰
            deepConv.context.originalQuestion = groupConv.context.question; // ä¿å­˜åŸå§‹é—®é¢˜
            deepConv.context.schools = subj.schools || []; // ç›´æ¥ä¿å­˜è¯¥å­¦ç§‘çš„æ´¾ç³»ä¿¡æ¯
            console.log('DEBUG selectSubjectAndStartDeepChat:', {
                subjectName: subjectName,
                initialSchools: deepConv.context.schools,
                subj_schools: subj.schools
            });
            
            // 1. é¦–å…ˆæ·»åŠ æ¬¢è¿æ¶ˆæ¯ï¼ˆæ”¾åœ¨æœ€å‰é¢ï¼‰
            deepConv.addMessage({
                type: 'system',
                sender: "Let's Talk åŠ©æ‰‹",
                content: `æ¬¢è¿è¿›å…¥ ${subjectIcon} ${subjectName} çš„æ·±å…¥è®¨è®ºã€‚`,
                avatar: 'ğŸ“',
                timestamp: new Date()
            });
            
            // 2. æ·»åŠ åŸå§‹é—®é¢˜å’Œè¯¥å­¦ç§‘çš„å›ç­”ä½œä¸ºä¸Šä¸‹æ–‡
            if (groupConv.context.question) {
                deepConv.addMessage({
                    type: 'user',
                    sender: 'æˆ‘',
                    content: `ã€åŸå§‹é—®é¢˜ã€‘${groupConv.context.question}`,
                    avatar: 'ğŸ‘¤',
                    timestamp: new Date()
                });
                
                // æ·»åŠ è¯¥å­¦ç§‘å¯¹åŸå§‹é—®é¢˜çš„å›ç­”ä½œä¸ºä¸Šä¸‹æ–‡
                deepConv.addMessage({
                    type: 'agent',
                    sender: subjectName,
                    content: subj.answer,
                    avatar: subjectIcon,
                    timestamp: new Date()
                });
            }
            
            conversations.push(deepConv);
            currentConversationId = deepConv.id;
            renderConversationList();
            renderMessages(deepConv);
            
            // è·å–è¯¥å­¦ç§‘çš„å»ºè®®é—®é¢˜å’Œæ´¾ç³»åˆ—è¡¨ï¼ˆä¸€è¿›æ¥å°±æ˜¾ç¤ºï¼‰
            showTypingIndicator();
            try {
                const response = await fetch('/api/deep-chat-init', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        subject_name: subjectName,
                        question: groupConv.context.question
                    })
                });
                
                const data = await response.json();
                removeTypingIndicator();
                
                if (data.success) {
                    // ä¿å­˜æ´¾ç³»ä¿¡æ¯åˆ°å¯¹è¯ä¸Šä¸‹æ–‡
                    if (data.schools) {
                        deepConv.context.schools = data.schools;
                    }
                    
                    // æ˜¾ç¤ºå»ºè®®é—®é¢˜åœ¨å³ä¾§
                    if (data.suggestions) {
                        showSuggestions(data.suggestions, subjectName, subjectIcon);
                    }
                    
                    // åœ¨è·å–æ´¾ç³»æ•°æ®åæ›´æ–°ä¾§è¾¹æ ï¼Œç¡®ä¿æ´¾ç³»é€‰é¡¹èƒ½æ˜¾ç¤º
                    updateSidebar(deepConv);
                }
            } catch (error) {
                removeTypingIndicator();
                console.error('è·å–å»ºè®®é—®é¢˜å¤±è´¥:', error);
                // å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨åŸæœ‰çš„å»ºè®®å’Œæ´¾ç³»
                if (subj.suggestions) {
                    showSuggestions(subj.suggestions, subjectName, subjectIcon);
                }
                updateSidebar(deepConv);
            }
        }

        async function displaySubjectAnswers(subjects) {
            const currentConv = conversations.find(c => c.id === currentConversationId);
            if (!currentConv) return;
            
            for (let i = 0; i < subjects.length; i++) {
                const subject = subjects[i];
                
                // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥
                showTypingIndicator();
                
                // å»¶è¿Ÿæ—¶é—´ï¼šåŸºç¡€å»¶è¿Ÿ + éšæœºæ³¢åŠ¨ï¼ˆæ¨¡æ‹ŸçœŸå®æ‰“å­—é€Ÿåº¦ï¼‰
                const baseDelay = messageDelay;
                const randomDelay = Math.floor(Math.random() * 600) + 200; // 200-800mséšæœº
                await sleep(baseDelay + randomDelay);
                
                // ç§»é™¤æ­£åœ¨è¾“å…¥
                removeTypingIndicator();
                
                // é¦–è½®ç¾¤èŠï¼ˆå­¦ç§‘ç›²ç›’ï¼‰ï¼šæŒ‰å­¦ç§‘èº«ä»½å±•ç¤ºï¼Œä¸ä½¿ç”¨æ´¾ç³»æˆ–äººç‰©
                const displayName = subject.name;
                const displayAvatar = subject.icon;
                
                // æ·»åŠ æ¶ˆæ¯
                addMessage('agent', displayName, subject.answer, displayAvatar);
                
                // åŒæ—¶æ·»åŠ åˆ°å¯¹è¯å†å²
                currentConv.messages.push({
                    role: 'assistant',
                    content: subject.answer,
                    sender: displayName,
                    avatar: displayAvatar
                });
                
                // æ¶ˆæ¯å‘å‡ºåçš„çŸ­æš‚åœé¡¿
                await sleep(400);
            }
        }

        // æ˜¾ç¤ºä¸‹ä¸€æ­¥æ“ä½œ
        function showNextActions(subjects) {
            const nextActions = document.getElementById('nextActions');
            // æ˜¾ç¤ºnextActions
            nextActions.style.display = 'block';
            
            // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            const actionButtons = nextActions.querySelector('.action-buttons');
            if (actionButtons) {
                actionButtons.innerHTML = `
                    <button onclick="resetAndAskNewQuestion()" style="padding: 12px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; width: 100%; font-weight: 500;">æ¢ä¸€æ‰¹</button>
                    <button onclick="showDeepChatOptions()" style="padding: 12px 20px; background: #764ba2; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; width: 100%; font-weight: 500;">æ·±å…¥å¯¹è¯</button>
                `;
            }
            
            // éšè—å»ºè®®å’ŒPKé€‰é¡¹
            const suggestionsSection = document.getElementById('suggestionsSection');
            if (suggestionsSection) suggestionsSection.style.display = 'none';
            
            const schoolPKSection = document.getElementById('schoolPKSection');
            if (schoolPKSection) schoolPKSection.style.display = 'none';
            
            const pkResultSection = document.getElementById('pkResultSection');
            if (pkResultSection) pkResultSection.style.display = 'none';
        }

        // æ›´æ–°æ·±å…¥å¯¹è¯æŒ‰é’®çŠ¶æ€
        function updateDeepChatBtn() {
            const selected = document.querySelector('input[name="singleChat"]:checked');
            document.getElementById('deepChatBtn').disabled = !selected;
        }
        
        // æ›´æ–°æ´¾åˆ«PKæŒ‰é’®çŠ¶æ€
        function updateSchoolPKBtn() {
            const selected = document.querySelectorAll('.school-checkbox:checked');
            document.getElementById('schoolPKBtn').disabled = selected.length !== 2;
        }
        
        // æ´¾ç³»å¤é€‰æ¡†å˜æ›´ï¼šæœ€å¤šåªèƒ½é€‰2ä¸ª
        function onSchoolCheckboxChange(checkbox) {
            const selected = Array.from(document.querySelectorAll('.school-checkbox:checked'));
            if (selected.length > 2) {
                // è¶…è¿‡2ä¸ªæ—¶ï¼Œå–æ¶ˆå½“å‰é€‰æ‹©å¹¶æç¤º
                checkbox.checked = false;
                const tip = document.getElementById('schoolPKSection');
                if (tip) {
                    tip.querySelector('.section-title').textContent = 'âš”ï¸ å­¦ç§‘æ´¾åˆ«PKï¼ˆæœ€å¤šé€‰æ‹©ä¸¤ä¸ªæ´¾åˆ«ï¼‰';
                }
            }
            // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼šPKéœ€è¦2ä¸ªï¼›å•èŠéœ€è¦1ä¸ª
            const pkBtn = document.getElementById('schoolPKBtn');
            const soloBtn = document.getElementById('schoolSoloBtn');
            if (pkBtn) pkBtn.disabled = selected.length !== 2;
            if (soloBtn) soloBtn.disabled = selected.length !== 1;
        }

        // å¼€å§‹æ·±å…¥å¯¹è¯ï¼ˆå·²åˆå¹¶åˆ°selectSubjectAndStartDeepChatï¼‰
        async function startDeepChat() {
            const selected = document.querySelector('input[name="singleChat"]:checked');
            if (!selected) return;
            await selectSubjectAndStartDeepChat(selected.value, selected.dataset.icon);
        }


        // æ˜¾ç¤ºå­¦ç§‘æ´¾åˆ«PKé€‰é¡¹
        function showSchoolPKOptions(schools, subjectName) {
            const section = document.getElementById('schoolPKSection');
            const selector = document.getElementById('schoolSelector');
            
            selector.innerHTML = '';
            schools.forEach(school => {
                const item = document.createElement('div');
                item.className = 'subject-checkbox-item';
                item.innerHTML = `
                    <input type="checkbox" class="school-checkbox" value="${school.name}" data-icon="${school.icon}" onchange="onSchoolCheckboxChange(this)">
                    <span class="subject-label">${school.icon} ${school.name}</span>
                    <div style="font-size: 11px; color: #999; margin-left: 24px; margin-top: 2px;">${school.description}</div>
                `;
                selector.appendChild(item);
            });
            
            // æ“ä½œæŒ‰é’®ï¼šä»…è¡¥å……æ´¾ç³»å•èŠæŒ‰é’®ï¼Œå¤ç”¨å·²æœ‰çš„â€œå¼€å§‹æ´¾åˆ«PKâ€æŒ‰é’®ï¼Œé¿å…é‡å¤
            const actionCard = section.querySelector('.action-card');
            if (actionCard && !actionCard.querySelector('#schoolSoloBtn')) {
                const soloBtn = document.createElement('button');
                soloBtn.className = 'action-btn';
                soloBtn.id = 'schoolSoloBtn';
                soloBtn.textContent = 'å¼€å§‹æ´¾ç³»å•èŠ';
                soloBtn.disabled = true;
                soloBtn.onclick = () => startSchoolSoloChat();
                actionCard.appendChild(soloBtn);
            }
            
            section.style.display = 'block';
        }

        // æ˜¾ç¤ºå»ºè®®é—®é¢˜
        function showSuggestions(suggestions, subjectName, icon) {
            const section = document.getElementById('suggestionsSection');
            const list = document.getElementById('suggestionsList');
            
            list.innerHTML = '';
            suggestions.forEach(suggestion => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = suggestion;
                item.onclick = () => askSuggestion(suggestion, subjectName, icon);
                list.appendChild(item);
            });
            
            section.style.display = 'block';
        }

        function updateRuntimeBadge(provider, usedDemo) {
            const badge = document.getElementById('runtimeBadge');
            if (!badge) return;
            if (usedDemo) {
                badge.textContent = 'ï¼ˆæ¼”ç¤ºå›é€€ï¼‰';
                badge.style.color = '#b26';
            } else if (provider === 'gemini') {
                badge.textContent = 'ï¼ˆGeminiï¼‰';
                badge.style.color = '#2a6';
            } else if (provider === 'openai') {
                badge.textContent = 'ï¼ˆOpenAIï¼‰';
                badge.style.color = '#26a';
            } else {
                badge.textContent = 'â€”';
                badge.style.color = '#666';
            }
        }

        // è¯¢é—®å»ºè®®é—®é¢˜
        async function askSuggestion(question, subjectName, icon) {
            // è·å–å½“å‰å¯¹è¯çš„åŸå§‹é—®é¢˜ä½œä¸ºä¸Šä¸‹æ–‡
            const currentConv = conversations.find(c => c.id === currentConversationId);
            const contextQuestion = currentConv && currentConv.context.question ? currentConv.context.question : '';
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage('user', 'æˆ‘', question);

            // ç­‰å¾…ä¸€ä¸‹å†æ˜¾ç¤ºæ­£åœ¨è¾“å…¥
            await sleep(600);
            
            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥
            showTypingIndicator();

            try {
                // å¦‚æœæ˜¯æ´¾ç³»å•èŠï¼Œæ³¨å…¥ä»£è¡¨äººç‰© persona
                let representative = undefined;
                if (currentConv && currentConv.context && currentConv.context.schoolChat) {
                    representative = currentConv.context.schoolChat.representativeName;
                }
                const response = await fetch('/api/deep-chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        question: question,
                        subject_name: subjectName,
                        context: contextQuestion,
                        representative
                    })
                });

                const data = await response.json();
                
                // æ¨¡æ‹Ÿæ€è€ƒæ—¶é—´
                await sleep(1000);
                removeTypingIndicator();

                if (data.success) {
                    // å±•ç¤ºæ—¶è‹¥æœ‰ä»£è¡¨äººç‰© personaï¼Œåˆ™ç”¨ä»£è¡¨äººç‰©å§“åä¸å¤´åƒ
                    let displayName = subjectName;
                    let displayAvatar = icon;
                    if (currentConv && currentConv.context && currentConv.context.schoolChat) {
                        displayName = currentConv.context.schoolChat.representativeName || subjectName;
                        displayAvatar = currentConv.context.schoolChat.representativeAvatar || icon;
                    }
                    addMessage('agent', displayName, data.answer, displayAvatar);
                    updateRuntimeBadge(data.llm_provider, data.used_demo);
                    showSuggestions(data.suggestions, subjectName, icon);
                } else {
                    addMessage('system', 'Let\'s Talk åŠ©æ‰‹', `é”™è¯¯ï¼š${data.error}`);
                }
            } catch (error) {
                removeTypingIndicator();
                addMessage('system', 'Let\'s Talk åŠ©æ‰‹', `è¯·æ±‚å¤±è´¥ï¼š${error.message}`);
            }
        }

        // å¼€å§‹æ´¾ç³»å•èŠï¼ˆä»¥ä»£è¡¨äººç‰© persona å•èŠï¼‰
        async function startSchoolSoloChat() {
            const selected = document.querySelectorAll('.school-checkbox:checked');
            const currentConv = conversations.find(c => c.id === currentConversationId);
            if (!currentConv || !currentConv.context.deepSubject) return;
            if (selected.length !== 1) return;
            
            const school = { name: selected[0].value, icon: selected[0].dataset.icon };
            const subjectInfo = currentConv.context.deepSubject;
            
            // è§£æä»£è¡¨äººç‰©
            const rep = getRepresentativeInfoForSchool(school.name) || { displayName: school.name, avatarUrl: '' };
            
            // åˆ›å»ºæ´¾ç³»å•èŠçª—å£ï¼ˆä¿ç•™ä¸Šä¸‹æ–‡ï¼‰
            const soloConv = new Conversation(
                CONVERSATION_TYPES.DEEP,
                `ä¸${rep.displayName}å¯¹è¯`,
                rep.avatarUrl || school.icon
            );
            soloConv.context.deepSubject = { name: subjectInfo.name, icon: subjectInfo.icon };
            soloConv.context.parentConvId = currentConv.id;
            soloConv.context.subjects = currentConv.context.subjects;
            soloConv.context.question = currentConv.context.question;
            soloConv.context.originalQuestion = currentConv.context.originalQuestion || currentConv.context.question;
            soloConv.context.schools = currentConv.context.schools || [];
            soloConv.context.schoolChat = {
                schoolName: school.name,
                representativeName: rep.displayName,
                representativeAvatar: rep.avatarUrl
            };
            
            // æ¬¢è¿æ¶ˆæ¯
            soloConv.addMessage({
                type: 'system',
                sender: "Let's Talk åŠ©æ‰‹",
                content: `å·²åˆ‡æ¢è‡³ ${subjectInfo.icon} ${subjectInfo.name} / ${school.name} æ´¾ç³»å•èŠã€‚å¯¹è¯å¯¹è±¡ï¼š${rep.displayName}`,
                avatar: 'ğŸ¤–',
                timestamp: new Date()
            });
            
            conversations.push(soloConv);
            switchConversation(soloConv.id);
        }

        // å¼€å§‹å­¦ç§‘æ´¾åˆ«PKï¼ˆåœ¨å½“å‰å­¦ç§‘å¯¹è¯æ¡†å†…è¿›è¡Œï¼Œä¸å•ç‹¬æ‹‰ç¾¤ï¼‰
        async function startSchoolPK() {
            const selected = document.querySelectorAll('.school-checkbox:checked');
            
            // è·å–å½“å‰å¯¹è¯ä¿¡æ¯
            const currentConv = conversations.find(c => c.id === currentConversationId);
            if (!currentConv || !currentConv.context.deepSubject) return;
            if (selected.length !== 2) return;

            const school1 = { name: selected[0].value, icon: selected[0].dataset.icon };
            const school2 = { name: selected[1].value, icon: selected[1].dataset.icon };
            const subjectInfo = currentConv.context.deepSubject;
            // æ›´ç¨³å¥çš„ä¸Šæ–‡é—®é¢˜è·å–ï¼šå½“å‰æ·±å…¥é—®é¢˜ â†’ åŸå§‹é—®é¢˜ â†’ çˆ¶å¯¹è¯é—®é¢˜
            const question = (function() {
                if (currentConv.context && currentConv.context.question) return currentConv.context.question;
                if (currentConv.context && currentConv.context.originalQuestion) return currentConv.context.originalQuestion;
                const parentId = currentConv.context && currentConv.context.parentConvId;
                if (parentId) {
                    const parent = conversations.find(c => c.id === parentId);
                    if (parent && parent.context && parent.context.question) return parent.context.question;
                }
                return '';
            })();

            // åœ¨å½“å‰å¯¹è¯è®¾ç½®PKçŠ¶æ€
            currentConv.context.pkState = {
                active: true,
                subjectName: subjectInfo.name,
                subjectIcon: subjectInfo.icon,
                school1: school1,
                school2: school2,
                currentRound: 1,
                maxRoundsPerTurn: 10,
                userInput: null,
                history: [],
                hasMore: false
            };
            // ä¿ç•™æ´¾ç³»åˆ—è¡¨ä¾›ä»£è¡¨äººç‰©è§£æ
            currentConv.context.schools = currentConv.context.schools || [];

            // æ·»åŠ ä¸Šæ–‡ä¿¡æ¯ï¼ˆåŸå§‹é—®é¢˜ï¼‰
            currentConv.addMessage({
                type: 'system',
                sender: "Let's Talk åŠ©æ‰‹",
                content: `ğŸ“Œ ã€é—®é¢˜ã€‘${question}`,
                avatar: 'ğŸ“',
                timestamp: new Date()
            });

            // ç­‰å¾…ä¸€ä¸‹
            await sleep(600);

            // æ·»åŠ ç”¨æˆ·æ“ä½œæ¶ˆæ¯
            addMessageToConversation('user', 'æˆ‘', `è®© ${school1.icon} ${school1.name} å’Œ ${school2.icon} ${school2.name} è¿›è¡Œè§‚ç‚¹PK`);

            // ç­‰å¾…ä¸€ä¸‹
            await sleep(600);
            
            // æ·»åŠ ç³»ç»Ÿæç¤º
            addMessageToConversation('system', 'Let\'s Talk åŠ©æ‰‹', `ğŸ¯ ${subjectInfo.icon} ${subjectInfo.name}å­¦ç§‘å†…çš„æ´¾åˆ«PKå¼€å§‹ï¼ä¸¤ä¸ªæ´¾åˆ«å°†è½®æµå‘è¡¨è§‚ç‚¹ï¼Œæ¯è½®${currentConv.context.pkState.maxRoundsPerTurn}å¥å¯¹è¯ã€‚`);

            // éšè—æ´¾ç³»é€‰æ‹©åŒºï¼Œé¿å…å¹²æ‰°
            const schoolPKSection = document.getElementById('schoolPKSection');
            if (schoolPKSection) schoolPKSection.style.display = 'none';

            // å†ç­‰å¾…ä¸€ä¸‹å†å¼€å§‹
            await sleep(1000);

            // æ‰§è¡Œç¬¬ä¸€è½®PK
            await executePKRound();
        }


        // æ‰§è¡ŒPKä¸€è½®ï¼ˆé»˜è®¤10å¥ï¼Œæ”¯æŒç”¨æˆ·è¾“å…¥ï¼‰
        async function executePKRound() {
            const currentConv = conversations.find(c => c.id === currentConversationId);
            if (!currentConv || !currentConv.context.pkState) return;
            
            const pkState = currentConv.context.pkState;
            
            showTypingIndicator();

            try {
                // è§£æä»£è¡¨äººç‰©ä¿¡æ¯ï¼Œä¼ ç»™åç«¯è®©LLMä»¥äººç‰©èº«ä»½ç”Ÿæˆå‘è¨€
                const rep1 = getRepresentativeInfoForSchool(pkState.school1.name);
                const rep2 = getRepresentativeInfoForSchool(pkState.school2.name);
                const response = await fetch('/api/school-pk', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        question: currentConv.context.question,
                        subject_name: pkState.subjectName,
                        school1: pkState.school1.name,
                        school2: pkState.school2.name,
                        representative1: rep1 && rep1.displayName ? rep1.displayName : undefined,
                        representative2: rep2 && rep2.displayName ? rep2.displayName : undefined,
                        round: pkState.currentRound,
                        max_statements: pkState.maxRoundsPerTurn,
                        user_input: pkState.userInput,
                        history: pkState.history
                    })
                });

                const data = await response.json();
                removeTypingIndicator();

                if (data.success) {
                    // é€æ¡æ˜¾ç¤ºå‘è¨€
                    await displayPKStatements(data.statements);
                    
                    // æ›´æ–°çŠ¶æ€
                    pkState.hasMore = data.has_more;
                    pkState.history = pkState.history.concat(data.statements);
                    pkState.userInput = null;
                    
                    // é¦–è½®é»˜è®¤è¾“å‡º10å¥ï¼Œä¹‹ååœæ­¢è‡ªåŠ¨ç»§ç»­ï¼Œæ”¹ä¸ºæ‰‹åŠ¨
                    showContinuePKButton();
                    // ä¿æŒä¼šè¯å¤„äºå¯ç»§ç»­çŠ¶æ€ï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ
                    pkState.active = true;
                } else {
                    addMessageToConversation('system', 'Let\'s Talk åŠ©æ‰‹', `é”™è¯¯ï¼š${data.error}`);
                    pkState.active = false;
                }
            } catch (error) {
                removeTypingIndicator();
                addMessageToConversation('system', 'Let\'s Talk åŠ©æ‰‹', `è¯·æ±‚å¤±è´¥ï¼š${error.message}`);
                pkState.active = false;
            }
        }

        // ä»£è¡¨äººç‰©å¤´åƒæ˜ å°„ï¼ˆWikimediaç­‰å…¬å¼€å›¾åƒï¼‰
        const representativeAvatarMap = {
            'è¨ç‰¹': 'https://upload.wikimedia.org/wikipedia/commons/6/68/Jean-Paul_Sartre_1967.jpg',
            'åŠ ç¼ª': 'https://upload.wikimedia.org/wikipedia/commons/9/9a/Albert_Camus%2C_gagnant_de_prix_Nobel%2C_portrait_en_buste%2C_posant_au_bureau%2C_les_bras_crois%C3%A9s.jpg',
            'æœå¨': 'https://upload.wikimedia.org/wikipedia/commons/0/02/John_Dewey_in_1902.jpg',
            'è©¹å§†æ–¯': 'https://upload.wikimedia.org/wikipedia/commons/5/55/William_James_in_1890.jpg',
            'ç¬›å¡å°”': 'https://upload.wikimedia.org/wikipedia/commons/0/04/Frans_Hals_-_Portrait_of_Ren%C3%A9_Descartes.jpg',
            'æ–¯å®¾è¯ºè': 'https://upload.wikimedia.org/wikipedia/commons/8/86/Spinoza.jpg',
            'ä¼‘è°Ÿ': 'https://upload.wikimedia.org/wikipedia/commons/9/9c/David_Hume.jpg',
            'æ´›å…‹': 'https://upload.wikimedia.org/wikipedia/commons/1/1c/JohnLocke.jpg',
            'å¼—æ´›ä¼Šå¾·': 'https://upload.wikimedia.org/wikipedia/commons/0/00/Sigmund_Freud%2C_by_Max_Halberstadt_%28cropped%29.jpg',
            'è£æ ¼': 'https://upload.wikimedia.org/wikipedia/commons/5/5a/Carl_Jung_%28cropped%29.png',
            'åç”Ÿ': 'https://upload.wikimedia.org/wikipedia/commons/7/79/John_Broadus_Watson.jpg',
            'æ–¯é‡‘çº³': 'https://upload.wikimedia.org/wikipedia/commons/c/cf/B.F._Skinner_at_Harvard_circa_1950.jpg',
            'çš®äºšæ°': 'https://upload.wikimedia.org/wikipedia/commons/a/a2/Jean_Piaget.jpg',
            'å¥ˆç‘Ÿ': 'https://upload.wikimedia.org/wikipedia/commons/2/24/Ulric_Neisser.jpg',
            'é©¬æ–¯æ´›': 'https://upload.wikimedia.org/wikipedia/commons/7/71/Abraham_Maslow.jpg',
            'ç½—æ°æ–¯': 'https://upload.wikimedia.org/wikipedia/commons/1/1d/Carl_Rogers.jpg',
            'äºšå½“Â·æ–¯å¯†': 'https://upload.wikimedia.org/wikipedia/commons/5/50/Adam_Smith_%28cropped%29.jpg',
            'æå˜‰å›¾': 'https://upload.wikimedia.org/wikipedia/commons/e/e0/David_Ricardo.jpg',
            'å‡¯æ©æ–¯': 'https://upload.wikimedia.org/wikipedia/commons/1/1e/John_Maynard_Keynes_1933.jpg',
            'å¡å°¼æ›¼': 'https://upload.wikimedia.org/wikipedia/commons/2/2e/Daniel_Kahneman%2C_2011.jpg',
            'å¡å‹’': 'https://upload.wikimedia.org/wikipedia/commons/0/0a/Richard_Thaler_2015.jpg',
            'å“ˆè€¶å…‹': 'https://upload.wikimedia.org/wikipedia/commons/6/6e/Friedrich_Hayek.jpg',
            'ç±³å¡æ–¯': 'https://upload.wikimedia.org/wikipedia/commons/8/8c/Ludwig_von_Mises.jpg',
            'å¸•æ£®æ–¯': 'https://upload.wikimedia.org/wikipedia/commons/8/86/Talcott_Parsons_%28cropped%29.jpg',
            'é»˜é¡¿': 'https://upload.wikimedia.org/wikipedia/commons/1/12/Robert_K._Merton.jpg',
            'é©¬å…‹æ€': 'https://upload.wikimedia.org/wikipedia/commons/4/45/Marx.jpg',
            'è¾¾ä¼¦å¤šå¤«': 'https://upload.wikimedia.org/wikipedia/commons/0/01/Ralf_Dahrendorf_%28cropped%29.jpg',
            'ç±³å¾·': 'https://upload.wikimedia.org/wikipedia/commons/9/97/George_Herbert_Mead_1904.jpg',
            'å¸ƒé²é»˜': 'https://upload.wikimedia.org/wikipedia/commons/9/9a/Herbert_Blumer.jpg',
            'èˆ’èŒ¨': 'https://upload.wikimedia.org/wikipedia/commons/4/46/Alfred_Schutz.jpg',
            'ä¼¯æ ¼': 'https://upload.wikimedia.org/wikipedia/commons/2/25/Peter_L._Berger.jpg'
        };

        function getRepresentativeInfoForSchool(schoolName) {
            const currentConv = conversations.find(c => c.id === currentConversationId);
            if (!currentConv || !currentConv.context || !currentConv.context.pkState) return null;
            const schools = (currentConv.context.schools) || [];
            const school = schools.find(s => s.name === schoolName);
            if (!school) return null;
            const reps = (school.representative || '').split('ã€');
            const rep = reps[0] ? reps[0].trim() : school.name;
            const avatar = representativeAvatarMap[rep] || '';
            return { displayName: rep, avatarUrl: avatar };
        }

        // é€æ¡æ˜¾ç¤ºPKå‘è¨€ï¼ˆä½¿ç”¨ä»£è¡¨äººç‰©ä¸çœŸå®å¤´åƒï¼‰
        async function displayPKStatements(statements) {
            const currentConv = conversations.find(c => c.id === currentConversationId);
            if (!currentConv) return;
            
            for (let i = 0; i < statements.length; i++) {
                const stmt = statements[i];
                
                // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥
                showTypingIndicator();
                
                // PKå‘è¨€å»¶è¿Ÿï¼šåŸºç¡€å»¶è¿Ÿ + éšæœºæ³¢åŠ¨
                const baseDelay = pkStatementDelay;
                const randomDelay = Math.floor(Math.random() * 400) + 200; // 200-600mséšæœº
                await sleep(baseDelay + randomDelay);
                
                // ç§»é™¤æ­£åœ¨è¾“å…¥
                removeTypingIndicator();
                
                // æ ¹æ®æ´¾ç³»æ‰¾åˆ°ä»£è¡¨äººç‰©ä¿¡æ¯
                const repInfo = getRepresentativeInfoForSchool(stmt.name);
                const displayName = repInfo && repInfo.displayName ? repInfo.displayName : stmt.name;
                const avatarUrl = repInfo && repInfo.avatarUrl ? repInfo.avatarUrl : '';
                
                // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯ï¼ˆå¤´åƒä¼˜å…ˆä½¿ç”¨çœŸå®URLï¼Œå¦åˆ™å›é€€åŸiconï¼‰
                addMessageToConversation('agent', displayName, stmt.content, avatarUrl || stmt.icon);
                
                // æ¶ˆæ¯å‘å‡ºåçš„çŸ­æš‚åœé¡¿ï¼ˆè§‚ç‚¹å±•ç¤ºæ—¶é—´ï¼‰
                await sleep(300);
            }
        }

        // æ˜¾ç¤ºç»§ç»­PKæŒ‰é’®
        function showContinuePKButton() {
            const container = document.getElementById('messagesContainer');
            const btnDiv = document.createElement('div');
            btnDiv.className = 'message';
            btnDiv.style.justifyContent = 'center';
            btnDiv.id = 'continuePKBtn';
            btnDiv.innerHTML = `
                <button class="send-btn" style="padding: 12px 30px; font-size: 15px;" onclick="continuePK()">
                    â­ï¸ ç»§ç»­ä¸‹ä¸€è½® (ç¬¬${pkState.currentRound + 1}è½®)
                </button>
            `;
            container.appendChild(btnDiv);
            container.scrollTop = container.scrollHeight;
        }

        // ç»§ç»­PK
        async function continuePK() {
            // ç§»é™¤ç»§ç»­æŒ‰é’®
            const btn = document.getElementById('continuePKBtn');
            if (btn) btn.remove();

            // å¢åŠ è½®æ¬¡
            pkState.currentRound++;

            // æ·»åŠ æç¤ºæ¶ˆæ¯
            addMessage('system', 'Let\'s Talk åŠ©æ‰‹', `ğŸ“ ç¬¬${pkState.currentRound}è½®å¼€å§‹ï¼`);

            // ç­‰å¾…ä¸€ä¸‹å†å¼€å§‹
            await sleep(800);

            // æ‰§è¡Œä¸‹ä¸€è½®ï¼ˆåŠ é”ï¼‰
            window.uiState.outputLocked = true;
            window.uiState.typingCounter = (window.uiState.typingCounter || 0) + 1;
            await executePKRound();
            // è§£é™¤é”åœ¨ executePKRound å†…éƒ¨çš„ removeTypingIndicator ä¹‹å
        }

        // æ˜¾ç¤ºPKç»“æœï¼ˆå·²åºŸå¼ƒï¼Œæ”¹ç”¨é€æ¡æ˜¾ç¤ºï¼‰
        async function displayPKResults(pkResult, subject1, subject2) {
            // æ­¤å‡½æ•°å·²ä¸å†ä½¿ç”¨
        }

        // æ˜¾ç¤ºPKæ‘˜è¦ï¼ˆå·²åºŸå¼ƒï¼‰
        function showPKSummary(pkResult, subject1, subject2) {
            // æ­¤å‡½æ•°å·²ä¸å†ä½¿ç”¨
        }

        // å»¶è¿Ÿå‡½æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // å›è½¦å‘é€ + ç¤ºä¾‹é—®é¢˜äº‹ä»¶å§”æ‰˜
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('messageInput');
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
            
            // ç¤ºä¾‹é—®é¢˜ç‚¹å‡»å¤„ç†
            const exampleQuestions = document.getElementById('exampleQuestions');
            if (exampleQuestions) {
                exampleQuestions.addEventListener('click', function(e) {
                    const btn = e.target.closest('.example-btn');
                    if (btn) {
                        const question = btn.dataset.question;
                        if (question) {
                            selectQuestion(question);
                        }
                    }
                });
            }
        });

        // PKæ—¶æ¥æ”¶ç”¨æˆ·è¾“å…¥
        async function submitUserInputToPK() {
            const input = document.getElementById('messageInput');
            const userMessage = input.value.trim();
            if (!userMessage) return;
            
            const currentConv = conversations.find(c => c.id === currentConversationId);
            if (!currentConv || !currentConv.context.pkState) return;
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            
            // è®°å½•ç”¨æˆ·è¾“å…¥
            const pkState = currentConv.context.pkState;
            pkState.userInput = userMessage;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessageToConversation('user', 'æˆ‘', userMessage);
            
            // ç­‰å¾…ä¸€ä¸‹åæ‰§è¡Œä¸‹ä¸€è½®PK
            await sleep(600);
            pkState.currentRound++;
            
            // æ‰§è¡Œä¸‹ä¸€è½®PKï¼ˆå°†ç”¨æˆ·è¾“å…¥ä¼ é€’ç»™APIï¼‰
            await executePKRound();
        }
        
        // æ˜¾ç¤ºç»§ç»­PKæŒ‰é’®ï¼ˆæ”¯æŒç»§ç»­æˆ–ç”¨æˆ·è¾“å…¥ï¼‰
        function showContinuePKButton() {
            const currentConv = conversations.find(c => c.id === currentConversationId);
            if (!currentConv || !currentConv.context.pkState) return;
            
            const pkState = currentConv.context.pkState;
            const container = document.getElementById('messagesContainer');
            const btnDiv = document.createElement('div');
            btnDiv.className = 'message';
            btnDiv.style.justifyContent = 'center';
            btnDiv.style.gap = '10px';
            btnDiv.id = 'continuePKBtn';
            btnDiv.innerHTML = `
                <div style="text-align: center; width: 100%;">
                    <p style="color: #666; font-size: 14px; margin-bottom: 12px;">å·²è¿›è¡Œ${pkState.currentRound}è½®å¯¹è¯ï¼Œè¦ç»§ç»­å—ï¼Ÿ</p>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="send-btn" style="padding: 10px 20px; font-size: 14px;" onclick="continuePK()">
                            â­ï¸ ç»§ç»­PK
                        </button>
                        <button class="send-btn" style="padding: 10px 20px; font-size: 14px; background: #999;" onclick="endPK()">
                            ğŸ ç»“æŸPK
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(btnDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // ç»§ç»­PK
        async function continuePK() {
            const currentConv = conversations.find(c => c.id === currentConversationId);
            if (!currentConv || !currentConv.context.pkState) return;
            
            const pkState = currentConv.context.pkState;
            
            // ç§»é™¤ç»§ç»­æŒ‰é’®
            const btn = document.getElementById('continuePKBtn');
            if (btn) btn.remove();

            // å¢åŠ è½®æ¬¡
            pkState.currentRound++;
            
            // é‡ç½®ç”¨æˆ·è¾“å…¥
            pkState.userInput = null;

            // æ·»åŠ æç¤ºæ¶ˆæ¯
            addMessageToConversation('system', 'Let\'s Talk åŠ©æ‰‹', `ğŸ“ ç¬¬${pkState.currentRound}è½®å¼€å§‹ï¼`);

            // ç­‰å¾…ä¸€ä¸‹å†å¼€å§‹
            await sleep(800);

            // æ‰§è¡Œä¸‹ä¸€è½®ï¼ˆåŠ é”ï¼‰
            window.uiState.outputLocked = true;
            window.uiState.typingCounter = (window.uiState.typingCounter || 0) + 1;
            await executePKRound();
            // è§£é™¤é”åœ¨ executePKRound å†…éƒ¨çš„ removeTypingIndicator ä¹‹å
        }
        
        // ç»“æŸPK
        async function endPK() {
            const currentConv = conversations.find(c => c.id === currentConversationId);
            if (!currentConv || !currentConv.context.pkState) return;
            
            const pkState = currentConv.context.pkState;
            
            // ç§»é™¤ç»§ç»­æŒ‰é’®
            const btn = document.getElementById('continuePKBtn');
            if (btn) btn.remove();
            
            // æ·»åŠ ç»“æŸæ¶ˆæ¯
            addMessageToConversation('system', 'Let\'s Talk åŠ©æ‰‹', `ğŸ PKç»“æŸï¼å…±è¿›è¡Œäº†${pkState.currentRound}è½®ç²¾å½©å¯¹è¯ã€‚é€šè¿‡${pkState.school1.icon} ${pkState.school1.name} å’Œ ${pkState.school2.icon} ${pkState.school2.name} çš„ç¢°æ’ï¼Œæˆ‘ä»¬å¯¹${pkState.subjectName}æœ‰äº†æ›´æ·±å…¥çš„ç†è§£ï¼`);
            
            pkState.active = false;
        }

    </script>
</body>
</html>
